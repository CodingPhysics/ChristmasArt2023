<!DOCTYPE html>
<html>
  <title>Christmas tree: Algorithmic art with vanilla JavaScript</title>
  <meta name="author" content="Markus Michelmann">
  <style>html,body{margin:0;}</style>
</html>
<body>
  <canvas id="cnv" width="1000" height="1500"></canvas>
  <script>
    let cnv, ctx, cos=Math.cos, sin=Math.sin, sqrt=Math.sqrt, PI=Math.PI;
    const add=(a,b)=>[a[0]+b[0],a[1]+b[1]], sub=(a,b)=>[a[0]-b[0],a[1]-b[1]],
          dot=(a,b)=>a.length ? a[0]*b[0]+a[1]*b[1] : [a*b[0], a*b[1]],
          rot=(x,a)=>[a[0]*cos(x)-a[1]*sin(x), a[0]*sin(x)+a[1]*cos(x)],
          rrange=(a,b)=>a+(b-a)*Math.random();

    window.onload = () => 
      { cnv=document.getElementById("cnv"), ctx=cnv.getContext("2d"), draw(); };
    window.addEventListener('resize', draw); 

    function circle(p, r, clr){ // Circle draw method
      ctx.fillStyle = clr, ctx.beginPath(), ctx.arc(...p,r,0,2*PI), ctx.fill(); 
    }
    function polygon(verts, clr){ // Polgon draw method
      ctx.fillStyle = clr, ctx.beginPath(), ctx.moveTo(...verts.at(-1));
      for(let v of verts) ctx.lineTo(...v); ctx.closePath(); ctx.fill(); 
    }
    function line(A, B, w, clr) { // Line draw method
      ctx.strokeStyle = clr, ctx.lineWidth = w, ctx.beginPath();
      ctx.moveTo(...A), ctx.lineTo(...B), ctx.stroke();
    }
    function lerpClr(x, clrA, clrB){ // Color interpolation
      let [__,r,g,b,_,R,G,B] = (clrA+clrB).split("").map(c => Number("0x"+c)),
          v = [[r,R],[g,G],[b,B]].map(u => ~~(u[0] + x*(u[1] - u[0])));
      return "#" + v.map(u => Number(u).toString(16)).reduce((r,s)=>r+s,""); 
    }
    function grad(A, B, stops, rA, rB){ // Creates a gradient with stops
      let g = rB ? ctx.createRadialGradient(...A, rA, ...B, rB) :
                   ctx.createLinearGradient(...A, ...B);
      for(let [x, clr] of stops) g.addColorStop(x, clr); return g;
    }
    function rectGrad(X, Y, w, clrA, clrB){// Draws rectangle with gradient
      let XY = sub(Y,X), AX = dot(0.5*w/sqrt(dot(XY,XY)), [XY[1],-XY[0]]),
          A = sub(X, AX), B = add(X, AX), C = add(B, XY), D = add(A, XY);
      polygon([A,B,C,D], grad(A, B, [[0,clrA],[1,clrB]])); 
    }
    function star(A, B, t, n, clrA, clrB){ // Draws n-pointed star
      let AB = sub(B,A), r = sqrt(dot(AB,AB)), a = [...Array(2*n).keys()],
          verts = a.map( k => add(A,dot(1 - t*(k%2), rot(k*PI/n, AB))) );
      polygon(verts, grad(A, A, [[0,clrA],[1,clrB]], 0.05*r, 0.6*r));
    }
    function flakes(n, x0, x1, y0, y1, r0, r1, clrA, clrB){ // Draws snow
      for(let clr, i = 0; i<n; i++)
        clr = lerpClr(Math.random(), clrA, clrB),
        circle([rrange(x0, x1), rrange(y0, y1)], rrange(r0, r1), clr);        
    } 
    function candle(A, r, clr0, clrA, clrB) { // Draws a candle light
      circle(A,r,clr0), star(A,add(A,[0,r]),0.9,4,clrA,clrB); 
    }
    function tree(A, B, phi, shrink, n, m){ // Tree draw method
      let AB = sub(B,A), C = add(A, dot(1-shrink, AB)), r = sqrt(dot(AB,AB))/25,
          branches = [...Array(n)].map((_,i) => i ? [] : [[A,C]]);
      for(let i = 0; i < n; i++){
        if(i) for([A, B] of branches[i-1]) for(let j = -1; j < 2; j++)
          branches[i].push([B, add(B, dot(shrink, rot(j*phi, sub(B, A))))]);
        let w = ~~(2.5*(n-i)-1), clr = lerpClr((i/(n-1))**2, '#542', '#2d2'),
            clr1 = lerpClr(0.5, clr, '#a42'), clr2 = lerpClr(0.5, clr, '#200');
        for(let [A, B] of branches[i]) 
          if(i < n/2) rectGrad(A, B, w, clr1, clr2);
          else        line(A, B, w, clr);
      }
      for(let k = 0, l = branches[n-1].length, s = ~~(l/m); k < l; k += s)
        candle(branches[n-1][k][0],r,'rgba(255,255,0,0.3)','#ffa','#fb0');
    }    
    function draw(){ // Main function
      let w = cnv.width=window.innerWidth, h = cnv.height=window.innerHeight,
          l = Math.min(0.88*w,0.8*h), A = [w/2,0.9*h], B = sub(A,[0,l]), 
          C = sub(B,[0,0.05*h]), D = add(A,[0,l]), E = [0,h/2], F = [w,h/2];
      rectGrad(E,F,h,'#004','#448'), flakes(200,0,w,0,h,1,3,'#ccc','#ffe');
      tree(A,B,0.6*Math.PI,0.6,9,21), star(B,C,0.4,5,'#ffa','#fb0');
      circle(D,1.01*l,grad(D,D,[[0,'#fff'],[1,'#ccc']],0.95*l,l)); 
      flakes(50,0,w,0,h,3,6,'#ccc','#ffe');
    }
  </script>
</body>
